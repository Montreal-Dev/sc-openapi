name: Daily OpenAPI Update

on:
  schedule:
    - cron: '0 0 * * *' # Daily at midnight
  workflow_dispatch:

jobs:
  daily-update:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v3

      # 2. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

        # 3. Install pnpm
      - name: Setup pnpm
        run: npm install -g pnpm

      # 4. Install dependencies with pnpm
      - name: Install dependencies
        run: pnpm install

      # 5. Check for OpenAPI updates
      - name: Check for updates
        id: check
        run: |
          output=$(pnpm run ci:check | grep 'changed=true' || true)
          echo "changed=$output" >> $GITHUB_OUTPUT

      # 6. Update patch & version
      - name: Update patch & version
        id: update
        if: ${{ steps.check.outputs.changed == 'changed=true' }}
        run: |
          pnpm run ci:update
          # Read the version from the script's output file if using GITHUB_OUTPUT
          # For newer GH syntax, ci-update.js should write: echo "openapi_version=$VERSION" >> $GITHUB_OUTPUT

      # 7. Generate SDK
      - name: Generate SDK
        if: ${{ steps.check.outputs.changed == 'changed=true' }}
        run: pnpm run ci:generate

      # 8. Commit & push changes /w version
      - name: Commit & Push
        if: ${{ steps.check.outputs.changed == 'changed=true' }}
        run: |
          VERSION=${{ steps.update.outputs.openapi_version }}
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git checkout -b openapi-update-$VERSION
          git add patches/ package.json src/openapi/generated
          git commit -m "ðŸ¤– Update OpenAPI patch, version & SDKs to v$VERSION"
          git push -u origin openapi-update-$VERSION

      # 9. Create Pull Request with version in title & body
      - name: Create Pull Request
        if: ${{ steps.check.outputs.changed == 'changed=true' }}
        uses: peter-evans/create-pull-request@v5
        with:
          branch: openapi-update-${{ steps.update.outputs.openapi_version }}
          title: 'ðŸ¤– Update OpenAPI spec & SDKs to v${{ steps.update.outputs.openapi_version }}'
          body: |
            Automated daily update to OpenAPI v${{ steps.update.outputs.openapi_version }}:
            - Patch file updated
            - package.json version updated
            - SDK regenerated
